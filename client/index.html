<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kross</title>
</head>

<body>
    <h1>Hello World 2</h1>
    <canvas id="ctx" width="500" height="500" style="border: 1px solid #000"></canvas>

    <div id="chat-text" style="width: 500px; height: 100px; overflow: scroll"></div>
    <form id="chat-form" type="submit">
        <input id="chat-input" type="text" style="width: 500px" />
    </form>


    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const chatText = document.getElementById("chat-text");
        const chatInput = document.getElementById("chat-input");
        const chatForm = document.getElementById("chat-form");
        const ctx = document.getElementById("ctx").getContext("2d");
        ctx.font = "30px Arial";

        socket.on('newPositions', (data) => {
            ctx.clearRect(0, 0, 500, 500);
            const {player, bullet} = data;
            for (var i = 0; i < player.length; i++) {
                ctx.fillText(player[i].number, player[i].x, player[i].y);
            }
            for (var i = 0; i < bullet.length; i++) {
                ctx.fillRect(bullet[i].x - 5, bullet[i].y - 5, 10, 10);
            }
        })

        socket.on("addToChat", (data) => {
            chatText.innerHTML += `<div>${data}</div>`;
        });

        socket.on("evalAnswer", (data) => console.log(data));

        chatForm.onsubmit = (event) => {
            event.preventDefault();
            if (chatInput.value[0] === "/") {
                socket.emit("evalServer", chatInput.value.slice(1));
            } else {
                socket.emit("sendMsgToServer", chatInput.value);
            }
            chatInput.value = "";
        }

        document.onkeydown = function (event) {
            if (event.keyCode === 68) //d
                socket.emit("keyPress", {inputId: "right", state: true})
            else if (event.keyCode === 65) //a
                socket.emit("keyPress", {inputId: "left", state: true})
            else if (event.keyCode === 83) //w
                socket.emit("keyPress", {inputId: "up", state: true})
            else if (event.keyCode === 87) //s
                socket.emit("keyPress", {inputId: "down", state: true})
        }

        document.onkeyup = function (event) {
            if (event.keyCode === 68) //d
                socket.emit("keyPress", {inputId: "right", state: false})
            else if (event.keyCode === 65) //a
                socket.emit("keyPress", {inputId: "left", state: false})
            else if (event.keyCode === 83) //s
                socket.emit("keyPress", {inputId: "up", state: false})
            else if (event.keyCode === 87) //s
                socket.emit("keyPress", {inputId: "down", state: false})
        }

        document.onmousedown = function (event) {
            socket.emit("keyPress", {inputId: "attack", state: true})
        }
        document.onmouseup = function (event) {
            socket.emit("keyPress", {inputId: "attack", state: false})
        }

        document.onmousemove = function (event) {
            const x = -250 + event.clientX - 8;
            const y = -250 + event.clientY - 8;
            const angle = Math.atan2(y, x) / Math.PI * 180;

            socket.emit("keyPress", {inputId: "mouseAngle", state: angle});
        }
    </script>
</body>

</html>